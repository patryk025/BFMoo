OBJECT=TAPE
TAPE:TYPE=ARRAY

OBJECT=TAPE_PTR
TAPE_PTR:TYPE=INTEGER
TAPE_PTR:VALUE=0

OBJECT=PROGRAM_LENGTH
PROGRAM_LENGTH:TYPE=INTEGER
PROGRAM_LENGTH:VALUE=0

OBJECT=PROGRAM_PTR
PROGRAM_PTR:TYPE=INTEGER
PROGRAM_PTR:VALUE=0

OBJECT=OUTPUT_PTR
OUTPUT_PTR:TYPE=INTEGER
OUTPUT_PTR:VALUE=0

OBJECT=JUMP_TABLE
JUMP_TABLE:TYPE=ARRAY

OBJECT=BF_CODE
BF_CODE:TYPE=STRING
BF_CODE:ONBRUTALCHANGED={PROGRAM_LENGTH^SET(BF_CODE^LENGTH());}

OBJECT=INITIALIZE_JUMP_TABLE
INITIALIZE_JUMP_TABLE:TYPE=BEHAVIOUR
INITIALIZE_JUMP_TABLE:CODE={@LOOP("{JUMP_TABLE^ADD(-1);}",0,PROGRAM_LENGTH,1);}

OBJECT=INITIALIZE_TAPE
INITIALIZE_TAPE:TYPE=BEHAVIOUR
INITIALIZE_TAPE:CODE={@LOOP("{TAPE^ADD(0);}",0,30000,1);}

#
# BRAINFUCK SYMBOLS
#

OBJECT=INCREMENT_POINTER_CHAR
INCREMENT_POINTER_CHAR:TYPE=STRING
INCREMENT_POINTER_CHAR:VALUE=>

OBJECT=DECREMENT_POINTER_CHAR
DECREMENT_POINTER_CHAR:TYPE=STRING
DECREMENT_POINTER_CHAR:VALUE=<

OBJECT=INCREMENT_VAL_AT_POINTER_CHAR
INCREMENT_VAL_AT_POINTER_CHAR:TYPE=STRING
INCREMENT_VAL_AT_POINTER_CHAR:VALUE=+

OBJECT=DECREMENT_VAL_AT_POINTER_CHAR
DECREMENT_VAL_AT_POINTER_CHAR:TYPE=STRING
DECREMENT_VAL_AT_POINTER_CHAR:VALUE=-

OBJECT=PRINT_CHARACTER_CHAR
PRINT_CHARACTER_CHAR:TYPE=STRING
PRINT_CHARACTER_CHAR:VALUE=.

OBJECT=GET_CHARACTER_CHAR
GET_CHARACTER_CHAR:TYPE=STRING
GET_CHARACTER_CHAR:VALUE=,

OBJECT=OPEN_LOOP_CHAR
OPEN_LOOP_CHAR:TYPE=STRING
OPEN_LOOP_CHAR:VALUE=[

OBJECT=CLOSE_LOOP_CHAR
CLOSE_LOOP_CHAR:TYPE=STRING
CLOSE_LOOP_CHAR:VALUE=]

OBJECT=INCREMENT_TAPE_PTR
INCREMENT_TAPE_PTR:TYPE=BEHAVIOUR
INCREMENT_TAPE_PTR:CODE={TAPE_PTR^INC();@IF("TAPE_PTR",">_","30000","{TAPE_PTR^SET(0);}","");}

OBJECT=DECREMENT_TAPE_PTR
DECREMENT_TAPE_PTR:TYPE=BEHAVIOUR
DECREMENT_TAPE_PTR:CODE={TAPE_PTR^DEC();@IF("TAPE_PTR","<","0","{TAPE_PTR^SET(29999);}","");}

OBJECT=INCREMENT_TAPE_PTR_VAL
INCREMENT_TAPE_PTR_VAL:TYPE=BEHAVIOUR
INCREMENT_TAPE_PTR_VAL:CODE={TAPE^ADDAT(TAPE_PTR,1);@IF("TAPE^GET(TAPE_PTR)",">","255","{TAPE^CHANGEAT(TAPE_PTR,0);}","");}

OBJECT=DECREMENT_TAPE_PTR_VAL
DECREMENT_TAPE_PTR_VAL:TYPE=BEHAVIOUR
DECREMENT_TAPE_PTR_VAL:CODE={TAPE^SUBAT(TAPE_PTR,1);@IF("TAPE^GET(TAPE_PTR)","<","0","{TAPE^CHANGEAT(TAPE_PTR,255);}","");}

OBJECT=ESCAPE_FROM_LOOP
ESCAPE_FROM_LOOP:TYPE=CONDITION
ESCAPE_FROM_LOOP:OPERAND1=TAPE^GET(TAPE_PTR)
ESCAPE_FROM_LOOP:OPERATOR=EQUAL
ESCAPE_FROM_LOOP:OPERAND2=0

OBJECT=BACK_TO_START_OF_LOOP
BACK_TO_START_OF_LOOP:TYPE=CONDITION
BACK_TO_START_OF_LOOP:OPERAND1=TAPE^GET(TAPE_PTR)
BACK_TO_START_OF_LOOP:OPERATOR=NOTEQUAL
BACK_TO_START_OF_LOOP:OPERAND2=0

OBJECT=JUMP_TO_END_OF_LOOP
JUMP_TO_END_OF_LOOP:TYPE=BEHAVIOUR
JUMP_TO_END_OF_LOOP:CONDITION=ESCAPE_FROM_LOOP
JUMP_TO_END_OF_LOOP:CODE={PROGRAM_PTR^SET([JUMP_TABLE^GET(PROGRAM_PTR)]);}

OBJECT=JUMP_TO_START_OF_LOOP
JUMP_TO_START_OF_LOOP:TYPE=BEHAVIOUR
JUMP_TO_START_OF_LOOP:CONDITION=BACK_TO_START_OF_LOOP
JUMP_TO_START_OF_LOOP:CODE={PROGRAM_PTR^SET([JUMP_TABLE^GET(PROGRAM_PTR)]);}

OBJECT=OUTPUT_PIXEL
OUTPUT_PIXEL:TYPE=BEHAVIOUR
OUTPUT_PIXEL:CODE={!HANDLE_OUTPUT^RUN();OUTPUT_PTR^INC();@IF("OUTPUT_PTR",">","255","{}","OUTPUT_PTR^SET(0);");}

OBJECT=READ_INPUT
READ_INPUT:TYPE=BEHAVIOUR
READ_INPUT:CODE={!HANDLE_INPUT^RUN();}

OBJECT=PREPROCESS_CODE
PREPROCESS_CODE:TYPE=BEHAVIOUR
PREPROCESS_CODE:CODE={@LOOP("{@STRING("CURRENT_CHAR",[BF_CODE^GET(_I_)]);@IF("CURRENT_CHAR","_","OPEN_LOOP_CHAR","{STACK^PUSH(_I_);}","");@IF("CURRENT_CHAR","_","CLOSE_LOOP_CHAR","{@INT("OPEN_ADDR",STACK^POP());JUMP_TABLE^CHANGEAT(OPEN_ADDR,_I_);JUMP_TABLE^CHANGEAT(_I_,OPEN_ADDR);}","");}",0,PROGRAM_LENGTH,1);}

OBJECT=EXECUTE_BF
EXECUTE_BF:TYPE=BEHAVIOUR
EXECUTE_BF:CODE={PROGRAM_PTR^SET(0);OUTPUT_PTR^SET(0);@WHILE("PROGRAM_PTR","<","PROGRAM_LENGTH","{@STRING("CURRENT_INSTR",[BF_CODE^GET(_I_)]);@IF("CURRENT_INSTR","_","INCREMENT_POINTER_CHAR","INCREMENT_TAPE_PTR","");@IF("CURRENT_INSTR","_","DECREMENT_POINTER_CHAR","DECREMENT_TAPE_PTR","");@IF("CURRENT_INSTR","_","INCREMENT_VAL_AT_POINTER_CHAR","INCREMENT_TAPE_PTR_VAL","");@IF("CURRENT_INSTR","_","DECREMENT_VAL_AT_POINTER_CHAR","DECREMENT_TAPE_PTR_VAL","");@IF("CURRENT_INSTR","_","OPEN_LOOP_CHAR","{JUMP_TO_END_OF_LOOP^RUNC();}","");@IF("CURRENT_INSTR","_","CLOSE_LOOP_CHAR","{JUMP_TO_START_OF_LOOP^RUNC();}","");PROGRAM_PTR^INC();}");}

OBJECT=CONSTRUCTOR
CONSTRUCTOR:TYPE=BEHAVIOUR
CONSTRUCTOR:CODE={INITIALIZE_TAPE^RUN();BF_CODE^SET($2);INITIALIZE_JUMP_TABLE^RUN();CLSSTACKOBJ^NEW("STACK");PREPROCESS_CODE^RUN();!JUMP_TABLE^SAVE("TEST_ARR.ARR");}
